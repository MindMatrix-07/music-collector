<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Admin</title>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #ccc;
            font-family: monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        /* LOGIN */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .login-box {
            text-align: center;
        }

        input {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            outline: none;
            text-align: center;
            font-size: 1.2rem;
        }

        input:focus {
            border-color: #2ecc71;
        }

        /* APP LAYOUT */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        /* HEADER */
        header {
            padding: 20px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            color: #2ecc71;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .tab-btn {
            background: #111;
            border: 1px solid #222;
            color: #888;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }

        .tab-btn.active {
            background: #222;
            border-bottom: 1px solid #222;
            color: #fff;
            font-weight: bold;
        }

        /* CONTENT */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* DASHBOARD GRID */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #111;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }

        .stat-val {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            margin-top: 5px;
        }

        .stat-lbl {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        /* ACTION BAR */
        .actions {
            margin-top: 30px;
            border-top: 1px solid #222;
            padding-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-green {
            background: #2ecc71;
            color: #000;
        }

        .btn-green:hover {
            background: #27ae60;
        }

        .btn-red {
            background: #e74c3c;
            color: #fff;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            text-align: left;
            color: #666;
            border-bottom: 1px solid #333;
            padding: 10px;
            font-size: 0.8rem;
        }

        td {
            border-bottom: 1px solid #1a1a1a;
            padding: 10px;
            font-size: 0.9rem;
            color: #ccc;
        }

        tr:hover {
            background: #111;
        }

        .code {
            font-family: monospace;
            color: #eebb00;
            font-size: 0.85rem;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            background: #333;
        }

        .status-ok {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-pend {
            background: rgba(230, 126, 34, 0.2);
            color: #e67e22;
        }

        /* JSON VIEWER */
        .json-row {
            display: none;
            background: #0a0a0a;
        }

        .json-row.open {
            display: table-row;
        }

        .json-content {
            padding: 10px;
            color: #888;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            padding: 10px 20px;
            border-radius: 4px;
            border-left: 4px solid #fff;
            opacity: 0;
            transition: 0.3s;
        }
    </style>
</head>

<body>

    <!-- AUTH -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2 style="color: #ff4444;">üîí Admin Access</h2>
            <input type="password" id="password" placeholder="Passkey" style="margin-bottom: 10px;">
            <!-- Turnstile Widget -->
            <div id="turnstile-widget"
                style="margin: 10px 0; min-height: 65px; display: flex; justify-content: center;"></div>
            <p id="login-status" style="color: #e74c3c; min-height: 20px; font-size: 0.9rem;"></p>
            <button class="btn btn-green" onclick="login()">ENTER</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="app hidden">
        <header>
            <h1>
                <span style="font-size:1.5rem">‚ö°</span> Collector Node
            </h1>
            <div class="tabs">
                <div class="tab-btn active" onclick="setView('dash')">Dashboard</div>
                <div class="tab-btn" onclick="setView('queue')">Queue <span id="tab-q-count"
                        style="font-size:0.8rem; opacity:0.6">(0)</span></div>
                <div class="tab-btn" onclick="setView('tracks')">Library</div>
            </div>
            <button class="btn btn-red btn-small" onclick="logout()">LOGOUT</button>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dash" class="content">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-lbl">Pending Requests</div>
                    <div id="dash-pending" class="stat-val">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Collected Tracks</div>
                    <div id="dash-total" class="stat-val">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">System Status</div>
                    <div class="stat-val" style="color: #3498db;">ONLINE</div>
                </div>
            </div>

            <div class="actions">
                <h3>Manual Override</h3>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Force the collector to run a search
                    cycle immediately.</p>
                <button class="btn btn-green" onclick="forceRun()">‚ö° RUN COLLECTOR NOW</button>
                <div id="run-log" style="margin-top: 15px; font-size: 0.9rem; color: #888;"></div>
            </div>
        </div>

        <!-- QUEUE VIEW -->
        <div id="view-queue" class="content hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Pending Requests</h3>
                <button class="btn btn-small btn-green" onclick="fetchQueue()">Refresh</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Query</th>
                        <th style="width: 150px">Added</th>
                        <th style="width: 80px">Action</th>
                    </tr>
                </thead>
                <tbody id="table-queue"></tbody>
            </table>
        </div>

        <!-- TRACKS VIEW -->
        <div id="view-tracks" class="content hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Recent Tracks (Last 50)</h3>
                <button class="btn btn-small btn-green" onclick="fetchTracks()">Refresh</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Cover</th>
                        <th>Title / Artist</th>
                        <th>YouTube ID</th>
                        <th style="width: 80px">Action</th>
                    </tr>
                </thead>
                <tbody id="table-tracks"></tbody>
            </table>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">Action Complete</div>

    <!-- Turnstile Script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback" async
        defer></script>

    <script>
        // Session Storage ONLY (Clears when tab closes)
        let TOKEN = sessionStorage.getItem('admin_pass');
        let TURNSTILE_ID = null;

        // Init
        if (TOKEN) {
            // Validate existing token
            refreshStats().then(ok => {
                if (ok) showApp();
                else logout();
            });
        }

        window.onloadTurnstileCallback = function () {
            // Renders the Turnstile widget
            TURNSTILE_ID = turnstile.render('#turnstile-widget', {
                sitekey: '0x4AAAAAACWBg7fNNlLEoGnG',
                theme: 'dark'
            });
        };

        // --- AUTH ---
        async function login() {
            const pass = document.getElementById('password').value;
            const status = document.getElementById('login-status');

            if (!pass) return status.textContent = 'Password Required';

            // Get Captcha Token
            let token = null;
            if (TURNSTILE_ID !== null) {
                token = turnstile.getResponse(TURNSTILE_ID);
            }

            // Note: backend will enforce token presence if secret is set.
            status.textContent = 'Verifying...';

            try {
                const res = await fetch('/api/admin?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass, token: token })
                });

                if (res.ok) {
                    TOKEN = pass;
                    sessionStorage.setItem('admin_pass', pass);
                    showApp();
                    refreshStats();
                } else {
                    const data = await res.json();
                    status.textContent = data.error || 'Access Denied';
                    if (TURNSTILE_ID !== null) turnstile.reset(TURNSTILE_ID);
                }
            } catch (e) {
                console.error(e);
                status.textContent = 'Network Error';
            }
        }

        function showApp() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function logout() {
            sessionStorage.removeItem('admin_pass');
            location.reload();
        }

        // --- NAVIGATION ---
        function setView(id) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="setView('${id}')"]`).classList.add('active');

            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');

            if (id === 'queue') fetchQueue();
            if (id === 'tracks') fetchTracks();
            if (id === 'dash') refreshStats();
        }

        // --- DATA FETCHING ---
        async function refreshStats() {
            const res = await api('stats');
            if (res) {
                updateDash(res);
                return true;
            }
            return false;
        }

        function updateDash(data) {
            document.getElementById('dash-pending').textContent = data.pending;
            document.getElementById('dash-total').textContent = data.total;
            document.getElementById('tab-q-count').textContent = `(${data.pending})`;
        }

        async function fetchQueue() {
            const data = await api('queue');
            const tbody = document.getElementById('table-queue');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Queue is empty</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><b style="color:#fff">${item.query}</b><br><span class="code">${item.id}</span></td>
                    <td>${new Date(item.created_at).toLocaleString()}</td>
                    <td><button class="btn btn-red btn-small" onclick="deleteItem('request_queue', '${item.id}')">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function fetchTracks() {
            const data = await api('tracks');
            const tbody = document.getElementById('table-tracks');
            tbody.innerHTML = '';

            data.forEach(t => {
                const meta = t.playback_metadata || {};
                const pid = `row-${t.id}`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="width: 60px">
                        <img src="${meta.thumbnail || ''}" style="width: 50px; height: 50px; border-radius: 4px; object-fit: cover; background: #222;">
                    </td>
                    <td style="cursor:pointer" onclick="toggleJson('${pid}')">
                        <div style="color:#fff; font-weight:bold">${t.title}</div>
                        <div style="color:#888">${t.artist}</div>
                        <div class="code" style="font-size:0.7rem; margin-top:4px;">‚ñº Click for Details</div>
                    </td>
                    <td class="code">${meta.youtube_id || '-'}</td>
                    <td><button class="btn btn-red btn-small" onclick="deleteItem('tracks', '${t.id}')">üóëÔ∏è</button></td>
                `;

                const jsonRow = document.createElement('tr');
                jsonRow.id = pid;
                jsonRow.className = 'json-row';
                jsonRow.innerHTML = `
                    <td colspan="4">
                        <div class="json-content">${JSON.stringify(t, null, 2)}</div>
                    </td>
                `;

                tbody.appendChild(tr);
                tbody.appendChild(jsonRow);
            });
        }

        function toggleJson(id) {
            document.getElementById(id).classList.toggle('open');
        }

        // --- ACTIONS ---
        async function forceRun() {
            const logId = document.getElementById('run-log');
            logId.textContent = 'Triggering...';
            const res = await fetch('/api/cron', { headers: { 'x-admin-password': TOKEN } });
            logId.textContent = `Server Response: ${await res.text()} (${new Date().toLocaleTimeString()})`;
            refreshStats();
        }

        async function deleteItem(table, id) {
            if (!confirm('Are you sure you want to delete this?')) return;

            try {
                const res = await fetch('/api/admin?action=delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-password': TOKEN },
                    body: JSON.stringify({ table, id })
                });

                if (res.ok) {
                    showToast('Deleted Successfully');
                    if (table === 'tracks') fetchTracks();
                    else fetchQueue();
                    refreshStats();
                } else {
                    alert('Delete failed');
                }
            } catch (e) { console.error(e); }
        }

        // --- HELPER ---
        async function api(action) {
            try {
                const res = await fetch(`/api/admin?action=${action}`, { headers: { 'x-admin-password': TOKEN } });
                if (res.status === 401) {
                    logout();
                    return null;
                }
                return await res.json();
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = 1;
            t.style.borderColor = '#2ecc71';
            setTimeout(() => t.style.opacity = 0, 2000);
        }
    </script>
</body>

</html>